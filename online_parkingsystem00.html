<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã‚³ã‚¤ãƒ³ãƒ‘ãƒ¼ã‚­ãƒ³ã‚°å…¥å‡ºåº«ã‚·ã‚¹ãƒ†ãƒ </title>
    <style>
        /* CSSã‚¹ã‚¿ã‚¤ãƒ«ã®æ–¹é‡ */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background-color: #f4f7f9;
            color: #333;
        }
        h1, h2 {
            color: #1e88e5;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 5px;
        }
        #entry-area, #log-area {
            background-color: #ffffff;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        #entry-area div {
            margin-bottom: 10px;
        }
        label {
            display: inline-block;
            width: 120px;
            font-weight: bold;
        }
        input[type="text"], select {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 200px;
        }
        button {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        button:hover {
            opacity: 0.9;
        }
        #entry-area button {
            background-color: #4caf50;
            color: white;
            margin-top: 10px;
        }

        /* ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¹ã‚¿ã‚¤ãƒ« */
        #parking-log-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        #parking-log-table th, #parking-log-table td {
            border: 1px solid #ddd;
            padding: 12px 8px;
            text-align: left;
        }
        #parking-log-table th {
            background-color: #e0f2f1;
            color: #00796b;
            font-weight: bold;
        }

        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã”ã¨ã®è‰²åˆ†ã‘ */
        .status-å…¥åº« {
            background-color: #e3f2fd; /* è–„ã„é’ */
            color: #1e88e5;
            font-weight: bold;
        }
        .status-å‡ºåº« {
            background-color: #f5f5f5; /* ç°è‰² */
            color: #757575;
        }
        .status-ä¸æ­£é§è»Š {
            background-color: #ffebee; /* è–„ã„èµ¤ */
            color: #e53935;
            font-weight: bold;
        }
        .exit-button {
            background-color: #ff9800;
            color: white;
            padding: 5px 10px;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <h1>ğŸ…¿ï¸ ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã‚³ã‚¤ãƒ³ãƒ‘ãƒ¼ã‚­ãƒ³ã‚°</h1>

    <div id="entry-area">
        <h2>å…¥åº«ç™»éŒ²</h2>
        <div>
            <label for="plate-number">è»Šä¸¡ãƒŠãƒ³ãƒãƒ¼:</label>
            <input type="text" id="plate-number" placeholder="ä¾‹: 1234" required>
        </div>
        <div>
            <label for="car-color">è»Šã®è‰²:</label>
            <input type="text" id="car-color" placeholder="ä¾‹: ç™½">
        </div>
        <div>
            <label for="car-type">è»Šç¨®:</label>
            <select id="car-type">
                <option value="è»½">è»½</option>
                <option value="SUV">SUV</option>
                <option value="ã‚»ãƒ€ãƒ³">ã‚»ãƒ€ãƒ³</option>
                <option value="å°å‹">å°å‹</option>
                <option value="ãƒ¯ã‚´ãƒ³">ãƒ¯ã‚´ãƒ³</option>
                <option value="box">Box</option>
            </select>
        </div>
        <div>
            <label for="car-maker">è²©å£²ä¼šç¤¾:</label>
            <select id="car-maker">
                <option value="Toyota">Toyota</option>
                <option value="Honda">Honda</option>
                <option value="Nissan">Nissan</option>
                <option value="Suzuki">Suzuki</option>
                <option value="Mazda">Mazda</option>
            </select>
        </div>
        <button onclick="registerEntry()">å…¥åº«</button>
    </div>

    <hr>

    <div id="log-area">
        <h2>é§è»ŠçŠ¶æ³ãƒ»å±¥æ­´</h2>
        <table id="parking-log-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>è»Šä¸¡ãƒŠãƒ³ãƒãƒ¼</th>
                    <th>å…¥åº«æ™‚åˆ»</th>
                    <th>å‡ºåº«æ™‚åˆ»</th>
                    <th>åˆ©ç”¨æ™‚é–“</th>
                    <th>æ–™é‡‘</th>
                    <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>
    </div>

    <script>
        // --- ãƒ‡ãƒ¼ã‚¿æ§‹é€  ---
        let parkingRecords = [];
        let nextId = 1; // IDè‡ªå‹•æ¡ç•ªç”¨

        // --- 3. æ–™é‡‘è¨ˆç®—JavaScripté–¢æ•°ï¼ˆæœ€é‡è¦ï¼‰---
        /**
         * é§è»Šæ™‚é–“ã«åŸºã¥ãæ–™é‡‘ã‚’è¨ˆç®—ã™ã‚‹é–¢æ•°
         * @param {string} entryTime - å…¥åº«æ™‚åˆ» (ISO 8601å½¢å¼: YYYY-MM-DDTHH:mm:ss)
         * @param {string} exitTime - å‡ºåº«æ™‚åˆ» (ISO 8601å½¢å¼)
         * @returns {number} è¨ˆç®—ã•ã‚ŒãŸæ¸…ç®—é‡‘é¡ (å††)
         */
        function calculateParkingFee(entryTime, exitTime) {
            const entry = new Date(entryTime);
            const exit = new Date(exitTime);

            // é§è»Šæ™‚é–“ï¼ˆãƒŸãƒªç§’ï¼‰
            const durationMs = exit - entry;
            if (durationMs <= 0) {
                return 0; // æ™‚é–“ãŒä¸æ­£ãªå ´åˆã¯0å††
            }

            // é§è»Šæ™‚é–“ï¼ˆæ™‚é–“ï¼‰: 1åˆ†ã§ã‚‚è¶…ãˆãŸã‚‰æ¬¡ã®1æ™‚é–“ã¨ã—ã¦åˆ‡ã‚Šä¸Šã’ã‚‹
            const durationHours = Math.ceil(durationMs / (1000 * 60 * 60));

            // æ–™é‡‘ä½“ç³»å®šæ•°
            const cycleHours = 12;      // 1ã‚µã‚¤ã‚¯ãƒ«12æ™‚é–“
            const cycleFee = 300;       // 12æ™‚é–“ã¾ã§ã®æœ€å¤§æ–™é‡‘
            const initialFeeHours = 2;  // 1æ™‚é–“100å††ã®é©ç”¨æ™‚é–“ï¼ˆ2æ™‚é–“ã¾ã§ï¼‰
            const initialFeeRate = 100; // 1æ™‚é–“ã‚ãŸã‚Šã®æ–™é‡‘

            let totalFee = 0;
            let remainingHours = durationHours;

            // 12æ™‚é–“ã”ã¨ã®ã‚µã‚¤ã‚¯ãƒ«ã§æ–™é‡‘ã‚’è¨ˆç®—ã—ã€åˆè¨ˆæ–™é‡‘ã‚’ç®—å‡ºã™ã‚‹
            while (remainingHours > 0) {
                // ç¾åœ¨ã®ã‚µã‚¤ã‚¯ãƒ«ã§ã®åˆ©ç”¨æ™‚é–“ï¼ˆæœ€å¤§12æ™‚é–“ï¼‰
                const currentCycleDuration = Math.min(remainingHours, cycleHours);

                // æ–™é‡‘è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆ12æ™‚é–“ã‚µã‚¤ã‚¯ãƒ«å†…ï¼‰
                if (currentCycleDuration <= initialFeeHours) {
                    // 2æ™‚é–“ä»¥å†…: 1æ™‚é–“æ¯ã«100å††
                    totalFee += currentCycleDuration * initialFeeRate;
                } else {
                    // 2æ™‚é–“è¶…ã€œ12æ™‚é–“ã¾ã§: ä¸€å¾‹300å††
                    totalFee += cycleFee;
                }

                // æ¬¡ã®ã‚µã‚¤ã‚¯ãƒ«ã¸
                remainingHours -= cycleHours;
            }

            // æœ€çµ‚çš„ãªåˆè¨ˆæ–™é‡‘ã‚’è¿”ã™
            return totalFee;
        }

        // --- 4. ä¸»è¦æ©Ÿèƒ½ã®JavaScripté–¢æ•° ---

        /**
         * é§è»Šæ™‚é–“ã®è¡¨ç¤ºç”¨ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’è¨ˆç®—ã™ã‚‹
         * @param {string} entryTime - å…¥åº«æ™‚åˆ»
         * @param {string | null} exitTime - å‡ºåº«æ™‚åˆ»
         * @returns {string} ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã•ã‚ŒãŸåˆ©ç”¨æ™‚é–“ (ä¾‹: "05æ™‚é–“30åˆ†" ã¾ãŸã¯ "åˆ©ç”¨ä¸­")
         */
        function getFormattedDuration(entryTime, exitTime) {
            if (!exitTime) return "åˆ©ç”¨ä¸­";

            const entry = new Date(entryTime);
            const exit = new Date(exitTime);

            let durationMs = exit - entry;
            if (durationMs < 0) return "ã‚¨ãƒ©ãƒ¼";

            const hours = Math.floor(durationMs / (1000 * 60 * 60));
            durationMs -= hours * (1000 * 60 * 60);
            const minutes = Math.floor(durationMs / (1000 * 60));

            // XXæ™‚é–“XXåˆ†ã®å½¢å¼ã§è¿”ã™
            return `${String(hours).padStart(2, '0')}æ™‚é–“${String(minutes).padStart(2, '0')}åˆ†`;
        }

        /**
         * å…¥åº«ç™»éŒ²å‡¦ç†
         */
        function registerEntry() {
            const plate = document.getElementById('plate-number').value;
            const color = document.getElementById('car-color').value;
            const type = document.getElementById('car-type').value;
            const maker = document.getElementById('car-maker').value;

            if (!plate) {
                alert('è»Šä¸¡ãƒŠãƒ³ãƒãƒ¼ã¯å¿…é ˆã§ã™ã€‚');
                return;
            }

            const now = new Date().toISOString(); // ç¾åœ¨æ™‚åˆ»ã‚’ISOå½¢å¼ã§å–å¾—

            const newRecord = {
                id: nextId++,
                plate: plate,
                entryTime: now,
                exitTime: null,
                carColor: color,
                carType: type,
                carMaker: maker,
                fee: 0,
                status: "å…¥åº«" // 'å…¥åº«', 'å‡ºåº«', 'ä¸æ­£é§è»Š'
            };

            parkingRecords.push(newRecord);
            alert(`è»Šä¸¡ãƒŠãƒ³ãƒãƒ¼ ${plate} ã®å…¥åº«ã‚’ç™»éŒ²ã—ã¾ã—ãŸã€‚ID: ${newRecord.id}`);

            // ãƒ•ã‚©ãƒ¼ãƒ ã®ãƒªã‚»ãƒƒãƒˆï¼ˆãƒ—ãƒ¬ãƒ¼ãƒˆãƒŠãƒ³ãƒãƒ¼ä»¥å¤–ã¯ä»»æ„ï¼‰
            document.getElementById('plate-number').value = '';
            document.getElementById('car-color').value = '';

            displayLog(); // å±¥æ­´è¡¨ç¤ºã‚’æ›´æ–°
        }

        /**
         * å‡ºåº«å‡¦ç†ã¨æ–™é‡‘è¨ˆç®—ã®å‘¼ã³å‡ºã—
         * @param {number} id - é§è»Šè¨˜éŒ²ID
         */
        function processExit(id) {
            const record = parkingRecords.find(r => r.id === id);

            if (!record || record.status !== 'å…¥åº«') {
                alert('å¯¾è±¡ã®å…¥åº«è¨˜éŒ²ãŒè¦‹ã¤ã‹ã‚‰ãªã„ã‹ã€æ—¢ã«å‡ºåº«æ¸ˆã¿ã§ã™ã€‚');
                return;
            }

            const now = new Date().toISOString();
            record.exitTime = now;

            // æ–™é‡‘è¨ˆç®—ã‚’å®Ÿè¡Œ
            const fee = calculateParkingFee(record.entryTime, record.exitTime);
            record.fee = fee;
            record.status = 'å‡ºåº«';

            alert(`ID: ${id}, è»Šä¸¡ãƒŠãƒ³ãƒãƒ¼: ${record.plate}\næ¸…ç®—é‡‘é¡: ${fee}å††ã§ã™ã€‚`);

            displayLog(); // å±¥æ­´è¡¨ç¤ºã‚’æ›´æ–°
        }

        /**
         * å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«ã®æ›´æ–°/è¡¨ç¤ºå‡¦ç†
         */
        function displayLog() {
            const tbody = document.querySelector('#parking-log-table tbody');
            tbody.innerHTML = ''; // æ—¢å­˜ã®è¡Œã‚’ã‚¯ãƒªã‚¢

            // æœ€æ–°ã®è¨˜éŒ²ãŒä¸Šã«æ¥ã‚‹ã‚ˆã†ã«é€†é †ã§å‡¦ç†
            parkingRecords.slice().reverse().forEach(record => {
                const row = tbody.insertRow();

                // è¡Œã®ã‚¯ãƒ©ã‚¹è¨­å®šï¼ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«å¿œã˜ã¦è‰²åˆ†ã‘ï¼‰
                row.className = `status-${record.status}`;

                // åˆ©ç”¨æ™‚é–“ã®è¨ˆç®—ã¨ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
                const duration = getFormattedDuration(record.entryTime, record.exitTime);

                // å„ã‚»ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ã‚’æŒ¿å…¥
                row.insertCell().textContent = record.id;
                row.insertCell().textContent = record.plate;
                // æ™‚åˆ»ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã¯é©å®œèª¿æ•´ (ä»Šå›ã¯ISOå½¢å¼ã‹ã‚‰ç¾åœ°æ™‚åˆ»ã«å¤‰æ›)
                row.insertCell().textContent = new Date(record.entryTime).toLocaleTimeString('ja-JP', {hour: '2-digit', minute:'2-digit', second:'2-digit'});
                row.insertCell().textContent = record.exitTime ? new Date(record.exitTime).toLocaleTimeString('ja-JP', {hour: '2-digit', minute:'2-digit', second:'2-digit'}) : 'â€•';
                row.insertCell().textContent = duration;
                row.insertCell().textContent = record.fee > 0 ? `${record.fee}å††` : 'â€•';
                row.insertCell().textContent = record.status;

                // æ“ä½œãƒœã‚¿ãƒ³ã®ã‚»ãƒ«
                const actionCell = row.insertCell();
                if (record.status === 'å…¥åº«') {
                    const button = document.createElement('button');
                    button.textContent = 'å‡ºåº«ãƒ»æ¸…ç®—';
                    button.className = 'exit-button';
                    button.onclick = () => processExit(record.id);
                    actionCell.appendChild(button);
                } else {
                    actionCell.textContent = 'å®Œäº†';
                }
            });
        }

        // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«ä¸€åº¦è¡¨ç¤ºã‚’åˆæœŸåŒ–ï¼ˆãƒ‡ãƒ¼ã‚¿ãŒãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ãªã„ãŸã‚ç©ºã®çŠ¶æ…‹ã§é–‹å§‹ï¼‰
        document.addEventListener('DOMContentLoaded', displayLog);

    </script>
</body>
</html>